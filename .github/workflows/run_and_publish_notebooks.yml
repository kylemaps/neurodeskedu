# =============================================================================
# Run Notebooks & Publish to GitHub Pages
# =============================================================================
# This workflow:
#   1. Detects new or modified Jupyter notebooks
#   2. Executes them in a Neurodesk container to validate they run correctly
#   3. Builds the Jupyter Book and publishes to GitHub Pages
#
# Triggers:
#   - Push to main (when notebooks or book markdown files change)
#   - Pull requests to main (for validation, no deployment)
#   - Manual dispatch (with options for image override, force execution, etc.)
# =============================================================================

name: Run Notebooks & Publish

defaults:
  run:
    shell: bash

# =============================================================================
# TRIGGERS
# =============================================================================
on:
  push:
    branches: [main]
    paths:
      - '**/*.ipynb'
      - 'books/**/*.md'

  pull_request:
    branches: [main]
    paths:
      - '**/*.ipynb'
      - 'books/**/*.md'
    types: [opened, synchronize, reopened, ready_for_review]

  workflow_dispatch:
    inputs:
      image_override:
        description: 'Override the Docker image (e.g. ghcr.io/neurodesk/neurodesktop/neurodesktop:2024-01-01)'
        required: false
        type: string
      force_execution:
        description: 'Force execution of all notebooks'
        required: false
        type: boolean
        default: false
      force_deploy_pages:
        description: 'Force deploy pages'
        required: false
        type: boolean
        default: false
      notebook_selector:
        description: 'Path relative to books/ (e.g. examples/workflows/nipype_short.ipynb)'
        required: false
        type: string
      use_self_hosted:
        description: 'Use self-hosted runner (check for self-hosted, default: GitHub-hosted)'
        required: false
        type: boolean
        default: false

# =============================================================================
# JOBS
# =============================================================================
jobs:

  # ---------------------------------------------------------------------------
  # SETUP: Determine runner and Neurodesk image
  # ---------------------------------------------------------------------------
  setup:
    name: Setup Environment
    runs-on: ubuntu-22.04
    outputs:
      runner: ${{ steps.select_runner.outputs.runner }}
      neurodesk_image: ${{ steps.get_image.outputs.neurodesk_image }}

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Select runner
        id: select_runner
        run: |
          # For workflow_dispatch, use the use_self_hosted input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ inputs.use_self_hosted }}" = "true" ]; then
              echo "runner=self-hosted" >> $GITHUB_OUTPUT
            else
              echo "runner=ubuntu-22.04" >> $GITHUB_OUTPUT
            fi
          # For push/PR, use self-hosted for main repo, ubuntu for forks
          elif [ "${{ github.repository }}" = "neurodesk/neurodeskedu" ]; then
            echo "runner=self-hosted" >> $GITHUB_OUTPUT
          else
            echo "runner=ubuntu-22.04" >> $GITHUB_OUTPUT
          fi

      - name: Determine Neurodesk image version
        id: get_image
        run: |
          if [ -n "${{ inputs.image_override }}" ]; then
            echo "neurodesk_image=${{ inputs.image_override }}" >> $GITHUB_OUTPUT
          else
            curl -s https://raw.githubusercontent.com/neurodesk/neurodesk.github.io/main/data/neurodesktop.toml -o neurodesktop.toml
            VERSION=$(grep 'jupyter_neurodesk_version = ' neurodesktop.toml | cut -d '"' -f 2)
            echo "neurodesk_image=ghcr.io/neurodesk/neurodesktop/neurodesktop:$VERSION" >> $GITHUB_OUTPUT
          fi

  # ---------------------------------------------------------------------------
  # SELECT NOTEBOOKS: Determine which notebooks to run (changed or manually selected)
  # ---------------------------------------------------------------------------
  select-notebooks:
    name: Select Notebooks to Run
    runs-on: ubuntu-22.04
    outputs:
      notebook_list: ${{ steps.list_notebooks.outputs.notebook_list }}

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Find changed notebook files
        id: find_changed
        uses: tj-actions/changed-files@c3a1bb2c992d77180ae65be6ae6c166cf40f857c
        with:
          path: "./books"
          files: |
            **/*.ipynb
          dir_names_exclude_current_dir: "true"

      - name: Build notebook list for matrix
        id: list_notebooks
        run: |
          # Determine which notebooks to run based on trigger type
          if [ "${{ inputs.force_execution }}" == "true" ]; then
            echo "Mode: Force execution of ALL notebooks"
            changed_notebooks=$(find books -name "*.ipynb" | sed 's|^books/||')

          elif [ -n "${{ inputs.notebook_selector }}" ]; then
            echo "Mode: Running specific notebook: ${{ inputs.notebook_selector }}"
            changed_notebooks="${{ inputs.notebook_selector }}"

          else
            echo "Mode: Running changed notebooks only"
            echo "Changed files: ${{ steps.find_changed.outputs.all_changed_files }}"
            changed_notebooks=$(echo "${{ steps.find_changed.outputs.all_changed_files }}")
          fi

          # Build JSON array for matrix strategy
          notebook_list='['
          for NOTEBOOK in $(echo "${changed_notebooks}"); do
            notebook_list+="\"${NOTEBOOK}\","
          done
          notebook_list=$(sed '$s/,$//' <<< $notebook_list)
          notebook_list+=']'

          echo "notebook_list=${notebook_list}"
          echo "notebook_list=${notebook_list}" >> $GITHUB_OUTPUT

  # ---------------------------------------------------------------------------
  # RUN NOTEBOOKS: Execute each changed notebook in Neurodesk container
  # ---------------------------------------------------------------------------
  run-notebooks:
    name: Run Notebook
    needs: [setup, select-notebooks]
    if: ${{ needs.select-notebooks.outputs.notebook_list != '[]' }}
    runs-on: ${{ needs.setup.outputs.runner }}
    timeout-minutes: 1500

    container:
      image: ${{ needs.setup.outputs.neurodesk_image }}
      volumes:
        - /home/runner/:/home/
      options: --user root

    strategy:
      fail-fast: false
      matrix:
        notebooks: ${{ fromJson(needs.select-notebooks.outputs.notebook_list) }}

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set notebook environment variables
        run: echo "NOTEBOOK=$(basename -s .ipynb ${{ matrix.notebooks }})" >> $GITHUB_ENV

      - name: Configure Git
        run: |
          git config --global user.email "mail.neurodesk@gmail.com"
          git config --global user.name "vnm-neurodesk"

      - name: Cache conda packages
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb
        with:
          path: /opt/conda/pkgs
          key: conda-pkgs-${{ runner.os }}-${{ hashFiles('.github/workflows/run_and_publish_notebooks.yml') }}
          restore-keys: |
            conda-pkgs-${{ runner.os }}-

      - name: Install Jupyter Book dependencies
        run: |
          mamba install -c conda-forge -y r-irkernel ipykernel "jupyter-book<2.0.0" ghp-import

      - name: Fix notebook kernelspec if needed
        run: |
          python3 << 'EOF'
          import json
          import sys

          notebook_path = "books/${{ matrix.notebooks }}"
          try:
              with open(notebook_path, 'r') as f:
                  notebook = json.load(f)

              # Fix conda-base-py or other problematic kernels
              if 'metadata' in notebook and 'kernelspec' in notebook['metadata']:
                  kernel_name = notebook['metadata']['kernelspec'].get('name', '')
                  if kernel_name == 'conda-base-py' or 'conda' in kernel_name:
                      print(f"Fixing kernelspec in {notebook_path}: {kernel_name} -> python3")
                      notebook['metadata']['kernelspec'] = {
                          "display_name": "Python 3",
                          "language": "python",
                          "name": "python3"
                      }
                      with open(notebook_path, 'w') as f:
                          json.dump(notebook, f, indent=1, ensure_ascii=False)
                          f.write('\n')
                  else:
                      print(f"Kernelspec OK: {kernel_name}")
          except Exception as e:
              print(f"Note: Could not process notebook (may not be ipynb): {e}")
          EOF

      - name: Execute notebook with Jupyter Book
        timeout-minutes: 1500
        working-directory: ./books
        shell: bash
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
          # Force bash subprocesses to source lmod init (for Jupyter kernels)
          BASH_ENV: /usr/share/lmod/lmod/init/bash
        run: |
          export PATH=/opt/conda/bin:$HOME/.local/bin:$PATH

          # Set environment variables for later steps
          echo "NOTEBOOK=$(basename -s .ipynb ${{ matrix.notebooks }})" >> $GITHUB_ENV
          echo "DIRNAME=$(dirname ${{ matrix.notebooks }})" >> $GITHUB_ENV

          # Initialize the module system for this shell
          if [ -f /usr/share/lmod/lmod/init/bash ]; then
            source /usr/share/lmod/lmod/init/bash
          elif [ -f /usr/share/module.sh ]; then
            source /usr/share/module.sh
          fi

          # Verify jupyter-book is available
          echo "Checking for jupyter-book..."
          which jupyter-book || echo "jupyter-book not found in PATH"

          # Execute the notebook
          jupyter-book build ${{ matrix.notebooks }}

      - name: Print notebook output logs
        if: always()
        working-directory: ./books
        run: |
          echo "========== NOTEBOOK OUTPUT ==========="
          echo "PWD: $(pwd)"

          echo "=== Files in notebook source directory ==="
          ls -la $(dirname ${{ matrix.notebooks }}) || true

          echo "=== .nii.gz files in books ==="
          find . -name "*.nii.gz" -type f 2>/dev/null || echo "No .nii.gz files found"

          echo "=== Log files ==="
          for LOG in $(find "$GITHUB_WORKSPACE/books" -name "*.log" -type f 2>/dev/null); do
            echo "--- $LOG ---"
            cat "$LOG"
          done
          echo "========================================"

      - name: Check for execution errors
        working-directory: ./books
        run: |
          ERROR_LOG=$(find "$GITHUB_WORKSPACE/books" -name "*.err.log" -type f 2>/dev/null | head -1)
          if [ -n "$ERROR_LOG" ]; then
            echo "::error::Notebook execution failed!"
            exit 1
          fi

      - name: Upload notebook build logs
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: notebook-logs-${{ env.NOTEBOOK }}
          path: |
            books/_build/**/reports/*.log
            books/_build/**/reports/*.err.log
            books/_build/**/.jupyter_cache/
          retention-days: 7
          if-no-files-found: ignore

  # ---------------------------------------------------------------------------
  # PUBLISH: Build complete book and deploy to GitHub Pages
  # ---------------------------------------------------------------------------
  publish-pages:
    name: Build & Publish to GitHub Pages
    needs: [run-notebooks, setup]
    if: ${{ always() && (needs.run-notebooks.result == 'success' || needs.run-notebooks.result == 'skipped') }}
    runs-on: ubuntu-22.04

    container:
      image: ${{ needs.setup.outputs.neurodesk_image }}
      volumes:
        - /home/runner/:/home/
      options: --user root

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Cache conda packages
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb
        with:
          path: /opt/conda/pkgs
          key: conda-pkgs-${{ runner.os }}-${{ hashFiles('.github/workflows/run_and_publish_notebooks.yml') }}
          restore-keys: |
            conda-pkgs-${{ runner.os }}-

      - name: Install Jupyter Book dependencies
        run: |
          mamba install -c conda-forge -y r-irkernel ipykernel "jupyter-book<2.0.0" ghp-import

      - name: Build complete Jupyter Book (without execution)
        working-directory: ./books
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PATH=/opt/conda/bin:$HOME/.local/bin:$PATH

          # Generate table of contents
          /bin/bash ../.github/scripts/write-toc-entry.sh

          # Disable notebook execution (already executed in run-notebooks job)
          sed -i 's/execute_notebooks: .*/execute_notebooks: off/' _config.yml
          cat _config.yml

          # Build the book
          jupyter-book build .

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./books/_build/html
          keep_files: true
